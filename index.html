<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…ƒç´ å¤§å¸« Chemistry Master</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM (UMD) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase Compat SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        /* Custom Animations */
        @keyframes bounce-in {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); opacity: 1; }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); }
        }
        .animate-bounce-in {
            animation: bounce-in 0.5s cubic-bezier(0.215, 0.610, 0.355, 1.000) both;
        }
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fade-in 0.5s ease-out forwards;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 to-blue-100 min-h-screen font-sans text-gray-800">

    <div id="root"></div>

    <script type="text/babel">
        // --- CONFIGURATION ---
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz2t756NbVZUpDkbbXl1t6oRlUdbzzFUKnA76ywbimZ4aWCDFI4PSJYU4OsWS6UxVIWOw/exec";
        
        // --- FIREBASE INIT ---
        let firebaseApp, db, auth;
        const appId = 'chem-game-html-final';

        try {
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
                apiKey: "YOUR_API_KEY_HERE_IF_LOCAL",
                authDomain: "YOUR_PROJECT.firebaseapp.com",
                projectId: "YOUR_PROJECT_ID",
                storageBucket: "YOUR_PROJECT.appspot.com",
                messagingSenderId: "SENDER_ID",
                appId: "APP_ID"
            };
            
            if (!firebase.apps.length) {
                firebaseApp = firebase.initializeApp(firebaseConfig);
            } else {
                firebaseApp = firebase.app();
            }
            db = firebase.firestore();
            auth = firebase.auth();
        } catch (e) {
            console.warn("Firebase Init Warning:", e);
            db = null; auth = null;
        }

        // --- ICONS ---
        const Icons = {
            Atom: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="1"/><path d="M20.2 20.2c2.04-2.03.02-7.36-4.5-11.9-4.54-4.52-9.87-6.54-11.9-4.5-2.04 2.03-.02 7.36 4.5 11.9 4.54 4.52 9.87 6.54 11.9 4.5Z"/><path d="M15.7 15.7c4.52-4.54 6.54-9.87 4.5-11.9-2.03-2.04-7.36-.02-11.9 4.5-4.52 4.54-6.54 9.87-4.5 11.9 2.03 2.04 7.36.02 11.9-4.5Z"/></svg>,
            Beaker: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4.5 3h15"/><path d="M6 3v16a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V3"/><path d="M6 14h12"/></svg>,
            FlaskConical: ({size=24}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10 2v7.527a2 2 0 0 1-.211.896L4.72 20.55a1 1 0 0 0 .9 1.45h12.76a1 1 0 0 0 .9-1.45l-5.069-10.127A2 2 0 0 1 14 9.527V2"/><path d="M8.5 2h7"/><path d="M7 16h10"/></svg>,
            Trophy: ({size=24, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>,
            Home: ({size=24}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>,
            RotateCcw: ({size=24}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>,
            CheckCircle2: ({size=24}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></svg>,
            ChevronRight: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m9 18 6-6-6-6"/></svg>,
            FileSpreadsheet: ({size=24}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M8 13h2"/><path d="M8 17h2"/><path d="M14 13h2"/><path d="M14 17h2"/></svg>,
            CloudUpload: ({size=24, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M12 12v9"/><path d="m16 16-4-4-4 4"/></svg>
        };

        // --- DATA ---
        const ELEMENTS_DATA = [
            { symbol: 'H', name: 'æ°«', group: '1A', period: 1 }, { symbol: 'Li', name: 'é‹°', group: '1A', period: 2 },
            { symbol: 'Na', name: 'éˆ‰', group: '1A', period: 3 }, { symbol: 'K', name: 'é‰€', group: '1A', period: 4 },
            { symbol: 'Rb', name: 'éŠ£', group: '1A', period: 5 }, { symbol: 'Cs', name: 'éŠ«', group: '1A', period: 6 },
            { symbol: 'Fr', name: 'éˆ', group: '1A', period: 7 },
            { symbol: 'Be', name: 'éˆ¹', group: '2A', period: 2 }, { symbol: 'Mg', name: 'é‚', group: '2A', period: 3 },
            { symbol: 'Ca', name: 'éˆ£', group: '2A', period: 4 }, { symbol: 'Sr', name: 'é¶', group: '2A', period: 5 },
            { symbol: 'Ba', name: 'é‹‡', group: '2A', period: 6 }, { symbol: 'Ra', name: 'é³', group: '2A', period: 7 },
            { symbol: 'B', name: 'ç¡¼', group: '3A', period: 2 }, { symbol: 'Al', name: 'é‹', group: '3A', period: 3 },
            { symbol: 'Ga', name: 'éµ', group: '3A', period: 4 }, { symbol: 'In', name: 'éŠ¦', group: '3A', period: 5 },
            { symbol: 'Tl', name: 'é‰ˆ', group: '3A', period: 6 },
            { symbol: 'C', name: 'ç¢³', group: '4A', period: 2 }, { symbol: 'Si', name: 'çŸ½', group: '4A', period: 3 },
            { symbol: 'Ge', name: 'éº', group: '4A', period: 4 }, { symbol: 'Sn', name: 'éŒ«', group: '4A', period: 5 },
            { symbol: 'Pb', name: 'é‰›', group: '4A', period: 6 },
            { symbol: 'N', name: 'æ°®', group: '5A', period: 2 }, { symbol: 'P', name: 'ç£·', group: '5A', period: 3 },
            { symbol: 'As', name: 'ç ·', group: '5A', period: 4 }, { symbol: 'Sb', name: 'éŠ»', group: '5A', period: 5 },
            { symbol: 'Bi', name: 'é‰', group: '5A', period: 6 },
            { symbol: 'O', name: 'æ°§', group: '6A', period: 2 }, { symbol: 'S', name: 'ç¡«', group: '6A', period: 3 },
            { symbol: 'Se', name: 'ç¡’', group: '6A', period: 4 }, { symbol: 'Te', name: 'ç¢²', group: '6A', period: 5 },
            { symbol: 'Po', name: 'é‡™', group: '6A', period: 6 },
            { symbol: 'F', name: 'æ°Ÿ', group: '7A', period: 2 }, { symbol: 'Cl', name: 'æ°¯', group: '7A', period: 3 },
            { symbol: 'Br', name: 'æº´', group: '7A', period: 4 }, { symbol: 'I', name: 'ç¢˜', group: '7A', period: 5 },
            { symbol: 'At', name: 'ç ˆ', group: '7A', period: 6 },
            { symbol: 'He', name: 'æ°¦', group: '8A', period: 1 }, { symbol: 'Ne', name: 'æ°–', group: '8A', period: 2 },
            { symbol: 'Ar', name: 'æ°¬', group: '8A', period: 3 }, { symbol: 'Kr', name: 'æ°ª', group: '8A', period: 4 },
            { symbol: 'Xe', name: 'æ°™', group: '8A', period: 5 }, { symbol: 'Rn', name: 'æ°¡', group: '8A', period: 6 },
            { symbol: 'Fe', name: 'éµ' }, { symbol: 'Cu', name: 'éŠ…' }, { symbol: 'Zn', name: 'é‹…' },
            { symbol: 'Ag', name: 'éŠ€' }, { symbol: 'Au', name: 'é‡‘' }, { symbol: 'Hg', name: 'æ±' },
            { symbol: 'Mn', name: 'éŒ³' }, { symbol: 'Co', name: 'éˆ·' }, { symbol: 'Ni', name: 'é³' },
            { symbol: 'Pt', name: 'é‰‘' }, { symbol: 'Cr', name: 'é‰»' }
        ];

        const IONS_DATA = [
            { formula: 'Hâº', name: 'æ°«é›¢å­' }, { formula: 'Liâº', name: 'é‹°é›¢å­' },
            { formula: 'Naâº', name: 'éˆ‰é›¢å­' }, { formula: 'Kâº', name: 'é‰€é›¢å­' },
            { formula: 'Agâº', name: 'éŠ€é›¢å­' }, { formula: 'NHâ‚„âº', name: 'éŠ¨æ ¹é›¢å­' },
            { formula: 'MgÂ²âº', name: 'é‚é›¢å­' }, { formula: 'CaÂ²âº', name: 'éˆ£é›¢å­' },
            { formula: 'BaÂ²âº', name: 'é‹‡é›¢å­' }, { formula: 'ZnÂ²âº', name: 'é‹…é›¢å­' },
            { formula: 'PbÂ²âº', name: 'é‰›é›¢å­' }, { formula: 'CuÂ²âº', name: 'éŠ…é›¢å­' },
            { formula: 'FeÂ²âº', name: 'äºéµé›¢å­' },
            { formula: 'AlÂ³âº', name: 'é‹é›¢å­' }, { formula: 'FeÂ³âº', name: 'éµé›¢å­' },
            { formula: 'Fâ»', name: 'æ°Ÿé›¢å­' }, { formula: 'Clâ»', name: 'æ°¯é›¢å­' },
            { formula: 'Brâ»', name: 'æº´é›¢å­' }, { formula: 'Iâ»', name: 'ç¢˜é›¢å­' },
            { formula: 'OHâ»', name: 'æ°«æ°§æ ¹é›¢å­' }, { formula: 'NOâ‚ƒâ»', name: 'ç¡é…¸æ ¹é›¢å­' },
            { formula: 'CHâ‚ƒCOOâ»', name: 'é†‹é…¸æ ¹é›¢å­' }, { formula: 'HCOâ‚ƒâ»', name: 'ç¢³é…¸æ°«æ ¹é›¢å­' },
            { formula: 'OÂ²â»', name: 'æ°§é›¢å­' }, { formula: 'SÂ²â»', name: 'ç¡«é›¢å­' },
            { formula: 'SOâ‚„Â²â»', name: 'ç¡«é…¸æ ¹é›¢å­' }, { formula: 'COâ‚ƒÂ²â»', name: 'ç¢³é…¸æ ¹é›¢å­' },
            { formula: 'POâ‚„Â³â»', name: 'ç£·é…¸æ ¹é›¢å­' }
        ];

        const GAME_TYPES = {
            MEMORY_ELEMENTS: 'elements',
            GROUP_ORDER: 'group_order',
            MEMORY_IONS: 'ions',
        };

        const PRAISE_MESSAGES = [
            "å¤ªå¼·äº†ï¼ğŸ”¥", "æ­£ç¢ºç„¡èª¤ï¼âœ¨", "è¨˜æ†¶åŠ›è¶…ç¾¤ï¼ğŸ§ ", 
            "åŒ–å­¸å¤©æ‰ï¼ğŸ§ª", "ç­”å°äº†ï¼ğŸ‰", "æ£’æ¥µäº†ï¼ğŸŒŸ", 
            "å¥½æ¨£çš„ï¼ğŸ’ª", "å‹¢å¦‚ç ´ç«¹ï¼ğŸš€"
        ];
        
        const getRandomPraise = () => PRAISE_MESSAGES[Math.floor(Math.random() * PRAISE_MESSAGES.length)];

        // --- COMPONENTS ---

        const FeedbackOverlay = ({ message, isVisible }) => {
            if (!isVisible) return null;
            return (
                <div className="fixed inset-0 pointer-events-none flex items-center justify-center z-50 animate-bounce-in">
                    <div className="bg-white/90 backdrop-blur-sm px-8 py-4 rounded-2xl shadow-2xl border-4 border-yellow-400 transform scale-110">
                        <span className="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-orange-500 to-red-600">
                            {message}
                        </span>
                    </div>
                </div>
            );
        };

        const Card = ({ content, type, isFlipped, isMatched, onClick }) => (
            <button
                onClick={onClick}
                disabled={isFlipped || isMatched}
                className={`relative w-24 h-32 m-2 rounded-xl shadow-md transition-all duration-300 ${isMatched ? 'opacity-0 scale-95 pointer-events-none' : 'opacity-100 scale-100'}`}
                style={{
                    transformStyle: 'preserve-3d',
                    transform: isFlipped ? 'rotateY(180deg)' : 'rotateY(0deg)',
                    transition: 'transform 0.5s'
                }}
            >
                {/* Front (Logo) */}
                <div 
                    className="absolute inset-0 w-full h-full bg-indigo-600 rounded-xl flex items-center justify-center"
                    style={{
                        backfaceVisibility: 'hidden',
                        WebkitBackfaceVisibility: 'hidden',
                        transform: 'rotateY(0deg)', // Explicitly 0
                        opacity: isFlipped ? 0 : 1 // Fallback opacity for browsers that struggle with backface
                    }}
                >
                    <div className="text-white opacity-50"><Icons.Atom /></div>
                </div>

                {/* Back (Content) */}
                <div 
                    className="absolute inset-0 w-full h-full bg-white border-2 border-indigo-200 rounded-xl flex flex-col items-center justify-center"
                    style={{
                        backfaceVisibility: 'hidden',
                        WebkitBackfaceVisibility: 'hidden',
                        transform: 'rotateY(180deg)', // Pre-rotated 180deg so when parent rotates 180, this becomes 360(0)
                        opacity: isFlipped ? 1 : 0 // Fallback opacity
                    }}
                >
                    <span className={`${type === 'formula' || type === 'symbol' ? 'text-2xl font-bold font-mono text-indigo-700' : 'text-lg font-bold text-gray-800'}`}>
                        {content}
                    </span>
                </div>
            </button>
        );

        const MemoryGame = ({ data, onComplete, gameType, user }) => {
            const [cards, setCards] = React.useState([]);
            const [flipped, setFlipped] = React.useState([]);
            const [matched, setMatched] = React.useState([]);
            const [moves, setMoves] = React.useState(0);
            const [timer, setTimer] = React.useState(0);
            const [isGameActive, setIsGameActive] = React.useState(false);
            const [feedback, setFeedback] = React.useState({ msg: '', visible: false });

            React.useEffect(() => {
                startNewGame();
            }, []);

            React.useEffect(() => {
                let interval;
                if (isGameActive) {
                    interval = setInterval(() => setTimer(t => t + 1), 1000);
                }
                return () => clearInterval(interval);
            }, [isGameActive]);

            const showPraise = () => {
                setFeedback({ msg: getRandomPraise(), visible: true });
                setTimeout(() => setFeedback(prev => ({ ...prev, visible: false })), 1500);
            };

            const startNewGame = () => {
                const shuffledData = [...data].sort(() => 0.5 - Math.random()).slice(0, 8);
                const deck = [];
                shuffledData.forEach((item, index) => {
                    deck.push({ 
                        id: `pair-${index}-a`, pairId: index, 
                        content: item.symbol || item.formula, type: item.symbol ? 'symbol' : 'formula' 
                    });
                    deck.push({ 
                        id: `pair-${index}-b`, pairId: index, 
                        content: item.name, type: 'name' 
                    });
                });
                setCards(deck.sort(() => 0.5 - Math.random()));
                setFlipped([]);
                setMatched([]);
                setMoves(0);
                setTimer(0);
                setIsGameActive(true);
            };

            const handleCardClick = (index) => {
                if (flipped.length === 2 || matched.includes(cards[index].pairId) || flipped.includes(index)) return;

                const newFlipped = [...flipped, index];
                setFlipped(newFlipped);

                if (newFlipped.length === 2) {
                    setMoves(m => m + 1);
                    const [firstIndex, secondIndex] = newFlipped;
                    if (cards[firstIndex].pairId === cards[secondIndex].pairId) {
                        const newMatched = [...matched, cards[firstIndex].pairId];
                        setMatched(newMatched);
                        setFlipped([]);
                        showPraise();
                        if (newMatched.length === 8) {
                           setIsGameActive(false);
                           const score = Math.max(0, 1000 - (timer * 2) - (moves * 10));
                           setTimeout(() => onComplete(score), 1500);
                        }
                    } else {
                        setTimeout(() => setFlipped([]), 1000);
                    }
                }
            };

            return (
                <div className="flex flex-col items-center relative">
                    <FeedbackOverlay message={feedback.msg} isVisible={feedback.visible} />
                    <div className="flex justify-between w-full max-w-2xl mb-4 px-4">
                        <div className="bg-white px-4 py-2 rounded-lg shadow text-indigo-800 font-bold">â³ æ™‚é–“: {timer}s</div>
                        <div className="bg-white px-4 py-2 rounded-lg shadow text-indigo-800 font-bold">ğŸ”„ æ­¥æ•¸: {moves}</div>
                    </div>
                    <div className="grid grid-cols-4 gap-2 md:gap-4 mb-6">
                        {cards.map((card, index) => (
                            <Card
                                key={card.id}
                                {...card}
                                isFlipped={flipped.includes(index) || matched.includes(card.pairId)}
                                isMatched={matched.includes(card.pairId)}
                                onClick={() => handleCardClick(index)}
                            />
                        ))}
                    </div>
                    <button onClick={startNewGame} className="flex items-center gap-2 bg-indigo-600 text-white px-6 py-2 rounded-full hover:bg-indigo-700 transition">
                        <Icons.RotateCcw size={18} /> é‡æ–°é–‹å§‹
                    </button>
                </div>
            );
        };

        const GroupSortGame = ({ onComplete }) => {
            const groups = ['1A', '2A', '3A', '4A', '5A', '6A', '7A', '8A'];
            const [currentGroup, setCurrentGroup] = React.useState('1A');
            const [pool, setPool] = React.useState([]);
            const [slots, setSlots] = React.useState([]);
            const [timer, setTimer] = React.useState(0);
            const [isGameActive, setIsGameActive] = React.useState(false);
            const [message, setMessage] = React.useState('');
            const [feedback, setFeedback] = React.useState({ msg: '', visible: false });

            React.useEffect(() => {
                startLevel(currentGroup);
            }, [currentGroup]);

            React.useEffect(() => {
                let interval;
                if (isGameActive) {
                    interval = setInterval(() => setTimer(t => t + 1), 1000);
                }
                return () => clearInterval(interval);
            }, [isGameActive]);

            const startLevel = (group) => {
                const groupElements = ELEMENTS_DATA.filter(e => e.group === group);
                const shuffled = [...groupElements].sort(() => 0.5 - Math.random());
                setPool(shuffled);
                setSlots(Array(groupElements.length).fill(null));
                setIsGameActive(true);
                setMessage('');
            };

            const handlePoolClick = (element) => {
                const firstEmptyIndex = slots.findIndex(s => s === null);
                if (firstEmptyIndex !== -1) {
                    const newSlots = [...slots];
                    newSlots[firstEmptyIndex] = element;
                    setSlots(newSlots);
                    setPool(pool.filter(e => e.symbol !== element.symbol));
                }
            };

            const handleSlotClick = (index) => {
                if (slots[index]) {
                    setPool([...pool, slots[index]]);
                    const newSlots = [...slots];
                    newSlots[index] = null;
                    setSlots(newSlots);
                }
            };

            const checkAnswer = () => {
                if (slots.includes(null)) {
                    setMessage('âš ï¸ è«‹å¡«æ»¿æ‰€æœ‰ç©ºæ ¼ï¼');
                    return;
                }
                const groupElements = ELEMENTS_DATA.filter(e => e.group === currentGroup).sort((a,b) => a.period - b.period);
                let isCorrect = true;
                slots.forEach((slot, index) => {
                    if (slot.symbol !== groupElements[index].symbol) isCorrect = false;
                });
                if (isCorrect) {
                    setFeedback({ msg: getRandomPraise(), visible: true });
                    setTimeout(() => setFeedback(prev => ({...prev, visible: false})), 1500);
                    setTimeout(() => {
                        const currentIndex = groups.indexOf(currentGroup);
                        if (currentIndex < groups.length - 1) {
                            setCurrentGroup(groups[currentIndex + 1]);
                        } else {
                            setIsGameActive(false);
                            const score = Math.max(0, 2000 - (timer * 5));
                            onComplete(score);
                        }
                    }, 1500);
                } else {
                    setMessage('âŒ é †åºéŒ¯èª¤ï¼Œè«‹å†æª¢æŸ¥ä¸€ä¸‹åŸå­åºæˆ–é€±æœŸï¼');
                }
            };

            return (
                <div className="flex flex-col items-center w-full max-w-3xl relative">
                    <FeedbackOverlay message={feedback.msg} isVisible={feedback.visible} />
                    <div className="bg-indigo-100 p-4 rounded-xl mb-6 text-center w-full">
                        <h3 className="text-xl font-bold text-indigo-800 mb-2">ç•¶å‰æŒ‘æˆ°: {currentGroup} æ—</h3>
                        <p className="text-sm text-indigo-600">è«‹ä¾ç…§ã€Œé€±æœŸå°åˆ°å¤§ã€ï¼ˆç”±ä¸Šå¾€ä¸‹ï¼‰çš„é †åºæ’åˆ—å…ƒç´ </p>
                    </div>
                    <div className="flex flex-wrap justify-center gap-2 mb-8 min-h-[80px] w-full bg-gray-50 p-4 rounded-lg border-2 border-dashed border-gray-300">
                        {slots.map((slot, index) => (
                            <div key={`slot-${index}`} onClick={() => handleSlotClick(index)} className={`w-16 h-20 rounded-lg flex flex-col items-center justify-center cursor-pointer transition-all ${slot ? 'bg-indigo-500 text-white shadow-lg transform hover:-translate-y-1' : 'bg-gray-200 text-gray-400'}`}>
                                {slot ? <><span className="font-bold text-xl">{slot.symbol}</span><span className="text-xs">{slot.name}</span></> : <span className="text-2xl font-bold opacity-20">{index + 1}</span>}
                            </div>
                        ))}
                    </div>
                    <div className="flex flex-wrap justify-center gap-2 mb-8">
                        {pool.map((element) => (
                            <button key={element.symbol} onClick={() => handlePoolClick(element)} className="w-16 h-20 bg-white border-2 border-indigo-200 rounded-lg flex flex-col items-center justify-center hover:bg-indigo-50 transition shadow-sm">
                                <span className="font-bold text-xl text-indigo-700">{element.symbol}</span>
                                <span className="text-xs text-gray-600">{element.name}</span>
                            </button>
                        ))}
                    </div>
                    {message && <div className={`mb-4 font-bold ${message.includes('æ­£ç¢º') ? 'text-green-600' : 'text-red-500'}`}>{message}</div>}
                    <button onClick={checkAnswer} className="bg-green-600 text-white px-8 py-3 rounded-full font-bold shadow-lg hover:bg-green-700 transition flex items-center gap-2">
                        <Icons.CheckCircle2 /> æäº¤ç­”æ¡ˆ
                    </button>
                </div>
            );
        };

        const Leaderboard = () => {
            const [scores, setScores] = React.useState([]);
            
            React.useEffect(() => {
                if (!db) {
                    console.warn("Firestore not available");
                    return;
                }
                const scoresRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('scores');
                
                // Firestore compat way
                const unsubscribe = scoresRef.orderBy('score', 'desc').limit(20)
                    .onSnapshot((snapshot) => {
                        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setScores(data);
                    }, (error) => {
                        console.warn("Firestore query error (maybe index missing):", error);
                        // Fallback without orderBy
                         scoresRef.limit(20).onSnapshot((snap) => {
                             const rawData = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                             setScores(rawData.sort((a,b) => b.score - a.score).slice(0, 20));
                         });
                    });
                return () => unsubscribe();
            }, []);

            const copyToCSV = () => {
                const header = "å§“å,éŠæˆ²é¡å‹,åˆ†æ•¸,æ—¥æœŸ\n";
                const rows = scores.map(s => {
                    const date = s.timestamp ? new Date(s.timestamp.seconds * 1000).toLocaleDateString() : '-';
                    return `${s.playerName},${s.gameType},${s.score},${date}`;
                }).join("\n");
                const csvContent = header + rows;
                const el = document.createElement('textarea');
                el.value = csvContent;
                document.body.appendChild(el);
                el.select();
                document.execCommand('copy');
                document.body.removeChild(el);
                alert("å·²è¤‡è£½ CSV æ ¼å¼è³‡æ–™ï¼æ‚¨å¯ä»¥ç›´æ¥åœ¨ Google Sheet ä¸­è²¼ä¸Šã€‚");
            };

            return (
                <div className="w-full max-w-2xl bg-white rounded-xl shadow-lg p-6">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-2xl font-bold text-gray-800 flex items-center gap-2"><Icons.Trophy className="text-yellow-500" /> æ’è¡Œæ¦œ</h2>
                        <button onClick={copyToCSV} className="text-sm bg-green-100 text-green-700 px-3 py-1 rounded hover:bg-green-200 flex items-center gap-1">
                            <Icons.FileSpreadsheet size={16}/> è¤‡è£½åˆ°è©¦ç®—è¡¨
                        </button>
                    </div>
                    <div className="overflow-x-auto">
                        <table className="w-full">
                            <thead><tr className="bg-gray-50 text-left text-gray-600"><th className="p-3 rounded-l-lg">æ’å</th><th className="p-3">å§“å</th><th className="p-3">éŠæˆ²</th><th className="p-3 text-right rounded-r-lg">åˆ†æ•¸</th></tr></thead>
                            <tbody>
                                {scores.length > 0 ? scores.map((s, i) => (
                                    <tr key={s.id} className="border-b border-gray-100 hover:bg-gray-50">
                                        <td className="p-3 font-bold text-gray-500">{i < 3 ? ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'][i] : i + 1}</td>
                                        <td className="p-3 font-medium">{s.playerName}</td>
                                        <td className="p-3 text-sm text-gray-500">{s.gameType === GAME_TYPES.MEMORY_ELEMENTS ? 'å…ƒç´ é…å°' : s.gameType === GAME_TYPES.GROUP_ORDER ? 'æ—ç¾¤æ’åº' : 'é›¢å­é…å°'}</td>
                                        <td className="p-3 text-right font-mono text-indigo-600 font-bold">{s.score}</td>
                                    </tr>
                                )) : (
                                    <tr><td colSpan={4} className="p-8 text-center text-gray-400">é€£ç·šä¸­æˆ–å°šç„¡ç´€éŒ„...</td></tr>
                                )}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [currentScreen, setCurrentScreen] = React.useState('menu'); 
            const [activeGame, setActiveGame] = React.useState(null);
            const [user, setUser] = React.useState(null);
            const [playerName, setPlayerName] = React.useState('');
            const [tempScore, setTempScore] = React.useState(null);
            const [uploadStatus, setUploadStatus] = React.useState('idle');

            React.useEffect(() => {
                const initAuth = async () => {
                    if (!auth) return;
                    
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await auth.signInWithCustomToken(__initial_auth_token);
                    } else {
                        await auth.signInAnonymously();
                    }
                };
                initAuth();
                if (auth) auth.onAuthStateChanged(setUser);
            }, []);

            const handleStartGame = (type) => {
                if (!playerName.trim()) {
                    alert("è«‹å…ˆè¼¸å…¥æ‚¨çš„åå­—ï¼");
                    return;
                }
                setActiveGame(type);
                setCurrentScreen('game');
                setTempScore(null);
                setUploadStatus('idle');
            };

            const handleGameComplete = async (score) => {
                setTempScore(score);
                const gameTypeName = activeGame === GAME_TYPES.MEMORY_ELEMENTS ? 'å…ƒç´ é…å°' : 
                                   activeGame === GAME_TYPES.GROUP_ORDER ? 'æ—ç¾¤æ’åº' : 'é›¢å­é…å°';

                if (user && playerName && db) {
                    try {
                        await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('scores').add({
                            playerName: playerName,
                            gameType: activeGame,
                            score: score,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                            userId: user.uid
                        });
                    } catch (e) {
                        console.error("Firestore save error:", e);
                    }
                }

                if (GOOGLE_SCRIPT_URL && GOOGLE_SCRIPT_URL.startsWith('http')) {
                    setUploadStatus('uploading');
                    try {
                        await fetch(GOOGLE_SCRIPT_URL, {
                            method: 'POST',
                            mode: 'no-cors',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                playerName: playerName,
                                gameType: gameTypeName,
                                score: score
                            })
                        });
                        setUploadStatus('done');
                    } catch (e) {
                        console.error("GAS upload error:", e);
                        setUploadStatus('error');
                    }
                }
                setTimeout(() => setCurrentScreen('scores'), 2500);
            };

            return (
                <div className="max-w-4xl mx-auto flex flex-col items-center p-4">
                    <header className="flex justify-between items-center w-full mb-8 bg-white/80 backdrop-blur p-4 rounded-2xl shadow-sm">
                        <div className="flex items-center gap-3">
                            <div className="bg-indigo-600 p-2 rounded-lg text-white"><Icons.FlaskConical size={24} /></div>
                            <h1 className="text-xl font-bold text-indigo-900 tracking-tight">å…ƒç´ å¤§å¸« Chemistry Master</h1>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={() => setCurrentScreen('menu')} className={`p-2 rounded-lg transition ${currentScreen === 'menu' ? 'bg-indigo-100 text-indigo-700' : 'hover:bg-gray-100 text-gray-500'}`}><Icons.Home size={20} /></button>
                            <button onClick={() => setCurrentScreen('scores')} className={`p-2 rounded-lg transition ${currentScreen === 'scores' ? 'bg-indigo-100 text-indigo-700' : 'hover:bg-gray-100 text-gray-500'}`}><Icons.Trophy size={20} /></button>
                        </div>
                    </header>

                    {currentScreen === 'menu' && (
                        <div className="w-full max-w-md animate-fade-in bg-white p-8 rounded-2xl shadow-xl text-center">
                            <h2 className="text-2xl font-bold mb-6 text-gray-800">æº–å‚™å¥½æŒ‘æˆ°äº†å—ï¼Ÿ</h2>
                            <div className="mb-6 text-left">
                                <label className="block text-sm font-medium text-gray-700 mb-2">è«‹è¼¸å…¥æ‚¨çš„åå­—</label>
                                <input type="text" value={playerName} onChange={(e) => setPlayerName(e.target.value)} placeholder="ä¾‹å¦‚ï¼šç‹å°æ˜" className="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-indigo-500 outline-none" />
                            </div>
                            <div className="space-y-3">
                                <button onClick={() => handleStartGame(GAME_TYPES.MEMORY_ELEMENTS)} className="w-full py-4 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-xl font-bold shadow-lg flex items-center justify-between px-6 hover:scale-[1.02] transition">
                                    <span className="flex items-center gap-3"><Icons.Atom /> å…ƒç´ ç¬¦è™Ÿé…å°</span><Icons.ChevronRight />
                                </button>
                                <button onClick={() => handleStartGame(GAME_TYPES.GROUP_ORDER)} className="w-full py-4 bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-xl font-bold shadow-lg flex items-center justify-between px-6 hover:scale-[1.02] transition">
                                    <span className="flex items-center gap-3"><Icons.Beaker /> é€±æœŸè¡¨æ’åºç‹</span><Icons.ChevronRight />
                                </button>
                                <button onClick={() => handleStartGame(GAME_TYPES.MEMORY_IONS)} className="w-full py-4 bg-gradient-to-r from-pink-500 to-pink-600 text-white rounded-xl font-bold shadow-lg flex items-center justify-between px-6 hover:scale-[1.02] transition">
                                    <span className="flex items-center gap-3"><Icons.FlaskConical /> é›¢å­å¤§æŒ‘æˆ°</span><Icons.ChevronRight />
                                </button>
                            </div>
                        </div>
                    )}

                    {currentScreen === 'game' && (
                        <div className="w-full flex flex-col items-center animate-fade-in">
                            {tempScore !== null ? (
                                <div className="bg-white p-8 rounded-2xl shadow-xl text-center w-full max-w-md">
                                    <h2 className="text-3xl font-bold text-indigo-600 mb-4">æŒ‘æˆ°å®Œæˆï¼</h2>
                                    <p className="text-gray-600 mb-2">æ‚¨çš„å¾—åˆ†</p>
                                    <div className="text-6xl font-mono font-bold text-yellow-500 mb-6">{tempScore}</div>
                                    <div className="flex items-center justify-center gap-2 text-sm text-gray-500 bg-gray-50 py-2 rounded-lg">
                                        {uploadStatus === 'idle' && <span>æˆç¸¾çµç®—ä¸­...</span>}
                                        {uploadStatus === 'uploading' && <span className="flex items-center gap-2 text-blue-600"><Icons.CloudUpload className="animate-bounce" size={16} /> æ­£åœ¨ä¸Šå‚³è‡³ Google Sheet...</span>}
                                        {uploadStatus === 'done' && <span className="flex items-center gap-2 text-green-600 font-bold"><Icons.CheckCircle2 size={16} /> æˆç¸¾å·²ä¸Šå‚³æˆåŠŸï¼</span>}
                                        {uploadStatus === 'error' && <span className="text-red-500">ä¸Šå‚³å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯</span>}
                                    </div>
                                </div>
                            ) : (
                                <>
                                    {activeGame === GAME_TYPES.MEMORY_ELEMENTS && <div className="w-full"><h2 className="text-center text-2xl font-bold mb-6 text-indigo-800">å…ƒç´ ç¬¦è™Ÿé…å°</h2><MemoryGame data={ELEMENTS_DATA} onComplete={handleGameComplete} /></div>}
                                    {activeGame === GAME_TYPES.MEMORY_IONS && <div className="w-full"><h2 className="text-center text-2xl font-bold mb-6 text-pink-800">å¸¸è¦‹é›¢å­é…å°</h2><MemoryGame data={IONS_DATA} onComplete={handleGameComplete} /></div>}
                                    {activeGame === GAME_TYPES.GROUP_ORDER && <div className="w-full flex justify-center"><GroupSortGame onComplete={handleGameComplete} /></div>}
                                </>
                            )}
                        </div>
                    )}

                    {currentScreen === 'scores' && <div className="w-full flex justify-center animate-fade-in"><Leaderboard /></div>}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
